{"version":3,"file":"marbel-diagram-lib.mjs","sources":["../../../projects/marbel-diagram-lib/src/lib/components/marble-diagram.component.ts","../../../projects/marbel-diagram-lib/src/lib/components/marble-diagram.component.html","../../../projects/marbel-diagram-lib/src/lib/marble-diagram.module.ts","../../../projects/marbel-diagram-lib/src/marbel-diagram-lib.ts"],"sourcesContent":["import {Component, Input, OnChanges, SimpleChanges, OnDestroy, ChangeDetectionStrategy, ChangeDetectorRef} from '@angular/core';\nimport {Observable, Subscription} from 'rxjs';\n\ninterface EventRecord {\n  time: number;\n  type: 'next' | 'error' | 'complete';\n  value?: string | any;\n}\n\n@Component({\n  selector: 'lib-marble-diagram',\n  templateUrl: './marble-diagram.component.html',\n  styleUrls: ['./marble-diagram.component.css'],\n  changeDetection: ChangeDetectionStrategy.OnPush,\n  standalone: false,\n})\nexport class MarbleDiagramComponent implements OnChanges, OnDestroy {\n  @Input() observable: Observable<string> | undefined;\n  @Input() duration: number = 1000;\n  @Input() maxMarkers: number = 10;\n\n  eventRecords: EventRecord[] = [];\n  subscription: Subscription | null = null;\n  isRendering = false;\n\n  hoveredEvent: EventRecord | null = null;\n\n  tooltipPosition = { x: 0, y: 0 };\n  showTooltip = false;\n\n  constructor(private changeDetectorRef: ChangeDetectorRef) {}\n\n  ngOnChanges(changes: SimpleChanges): void {\n    if (changes['observable'] && this.observable) {\n      this.eventRecords = [];\n      this.subscription?.unsubscribe();\n      this.visualizeObservable();\n    }\n  }\n\n  ngOnDestroy(): void {\n    this.subscription?.unsubscribe();\n  }\n\n  private visualizeObservable(): void {\n    if(!this.observable) return;\n\n    const startTime = Date.now();\n\n    const handleNext = (value: string) => {\n      this.addEventRecord({ time: Date.now() - startTime, type: 'next', value });\n    }\n    const handleError = (err: any) => {\n      this.addEventRecord({ time: Date.now() - startTime, type: 'error', value: err });\n    }\n    const handleComplete = () => {\n      this.addEventRecord({ time: Date.now() - startTime, type: 'complete' });\n    }\n\n    this.subscription = this.observable.subscribe({\n      next: handleNext,\n      error: handleError,\n      complete: handleComplete,\n    });\n\n    if (this.duration > 0) {\n      setTimeout(() => {\n        this.subscription?.unsubscribe();\n      }, this.duration);\n    }\n  }\n  private addEventRecord(record: EventRecord) {\n    if (this.eventRecords.length >= this.maxMarkers) {\n      this.eventRecords.shift(); // Удаляем самый старый маркер\n      this.subscription?.unsubscribe(); // Отписываемся при достижении лимита\n    }\n    this.eventRecords.push(record);\n    this.isRendering = true;\n    setTimeout(() => {\n      this.isRendering = false;\n      this.changeDetectorRef.markForCheck();\n    });\n  }\n  calculateMarkerPosition(eventTime: number): string {\n    if (this.duration < 0) {\n      const maxTime = Math.max(...this.eventRecords.map(e => e.time), 1000);\n      return `${(eventTime / maxTime) * 100}%`;\n    }\n    return `${(eventTime / this.duration) * 100}%`;\n  }\n  onMarkerHover(event: EventRecord | null, mouseEvent?: MouseEvent) {\n    this.hoveredEvent = event;\n    if (event && mouseEvent) {\n      const tooltipWidth = 100; // Примерная ширина тултипа\n      const windowWidth = window.innerWidth;\n\n      // Если тултип не помещается справа, показываем его слева\n      const x = mouseEvent.clientX + tooltipWidth > windowWidth\n        ? mouseEvent.clientX - tooltipWidth\n        : mouseEvent.clientX;\n\n      this.tooltipPosition = {\n        x: x,\n        y: mouseEvent.clientY\n      };\n      this.showTooltip = true;\n    } else {\n      this.showTooltip = false;\n    }\n  }\n}\n","<div class=\"marble-diagram\">\n  <div class=\"time-line\"></div>\n  <div\n    *ngFor=\"let event of eventRecords\"\n    class=\"marker\"\n    [class.next]=\"event.type === 'next'\"\n    [class.error]=\"event.type === 'error'\"\n    [class.complete]=\"event.type === 'complete'\"\n    [style.left]=\"calculateMarkerPosition(event.time)\"\n    (mouseenter)=\"onMarkerHover(event, $event)\"\n    (mouseleave)=\"onMarkerHover(null)\"\n  >\n    {{ event.value ? event.value.charAt(0) : event.type.charAt(0).toUpperCase() }}\n  </div>\n\n  <div *ngIf=\"showTooltip && hoveredEvent\" class=\"tooltip\" [ngStyle]=\"{left: tooltipPosition.x + 'px', top: tooltipPosition.y + 'px'}\">\n    <div>Time: {{ hoveredEvent.time }}ms</div>\n    <div *ngIf=\"hoveredEvent.value\">Value: {{ hoveredEvent.value }}</div>\n  </div>\n</div>\n","import { NgModule } from '@angular/core';\nimport {CommonModule, SlicePipe} from '@angular/common';\nimport { MarbleDiagramComponent } from './components/marble-diagram.component';\n\n@NgModule({\n  declarations: [MarbleDiagramComponent],\n  imports: [\n    SlicePipe,\n    CommonModule,\n  ],\n  exports: [MarbleDiagramComponent]\n})\nexport class MarbleDiagramModule { }\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './public-api';\n"],"names":[],"mappings":"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"}